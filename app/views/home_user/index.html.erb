<%= render 'layouts/user_navbar' %>

<%= form_with method: :get, class: 'form-inline offset-md-3 mt-2' do |form| %>
  <div class="form-group mb-2">
    <%= form.label "Filtrar por exame", class: "mr-3" %>
    <%= form.select :offered_exam, options_from_collection_for_select(@offered_exams, "id", "name"), {}, class: 'form-control' %>
  </div>
  <button class="btn btn-outline-info mb-2 ml-4">
    Buscar
  </button>
<% end %>

<hr>

<% unless @user.fields.empty? %>
  <div class="mt-3">

    <div style="width: 33%;" class="d-inline-block">
      <h4 class="text-center text-secondary">
        Exames aguardando in√≠cio <span id="waiting-exams-number"><%= @waiting_exams[:count] %></span>
      </h4>
      <div id="exams-waiting-chart">
        <% if @waiting_exams[:count] > 0 %>
          <%= pie_chart @waiting_exams[:relation], legend: false, colors: waiting_colors, id: 'waiting-exams-chart' %>
        <% end %>
      </div>
    </div>

    <div style="width: 33%;" class="d-inline-block border-right border-left">
      <h4 class="text-center text-primary">
        Exames em andamento <span id="in-progress-exams-number"><%= @exams_in_progress[:count] %></span>
      </h4>
      <div>
        <% if @exams_in_progress[:count] > 0 %>
          <%= pie_chart @exams_in_progress[:relation], legend: false, colors: in_progress_colors, id: 'in-progress-exams-chart' %>
        <% end %>
      </div>
    </div>

    <div style="width: 33%;" class="d-inline-block">
      <h4 class="text-center text-danger">
        Exames atrasados <span id="delayed-exams-number"><%= @delayed_exams[:count] %></span>
      </h4>
      <div>
        <% if @delayed_exams[:count] > 0 %>
          <%= pie_chart @delayed_exams[:relation], legend: false, colors: delayed_colors, id: 'delayed-exams-chart' %>
        <% end %>
      </div>
    </div>
  </div>

  <table class="table table-bordered text-center">
    <thead class="bg-secondary text-white">
      <th>
        <h4>
          Exame
        </h4>
      </th>
      <th>
        <h4>
          Paciente
        </h4>
      </th>
      <th>
        <h4>
          Amostra
        </h4>
      </th>
      <td>
        <h4>
          Iniciado em
        </h4>
      </td>
      <td>
        <h4>
          Status
        </h4>
      </td>
      <th>
        <h4></h4>
      </th>
    </thead>
    <tbody>
      <% @issues.each do |exam| %>
        <tr class="issue">
          <td>
            <%= exam.offered_exam.name %>
          </td>
          <td>
            <%= exam.attendance.patient.name %>
          </td>
          <td>
            <% unless exam.internal_code.nil? %>
              <%= exam.internal_code.code %>
            <% end %>
          </td>
          <td>
            <% unless exam.start_date.nil? %>
              <%= l exam.start_date %>
            <% else %>
              -
            <% end %>
          </td>
          <td>
            <%= exam_status_helper exam.exam_status_kind %>
          </td>
          <td>
            <%= link_to "Exame", workflow_path(exam.attendance, {tab: "exams"}), class: 'attendance-code' %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>


<% end %>
