<div style="overflow: auto;">
  <div class="form-group">
    <%= label_tag SampleKind.model_name.human %>
    <%= select_tag :sample_kind, options_from_collection_for_select(@sample_kinds, "id", "name"), class: 'form-control' %>
  </div>

  <div class="form-group">
    <%= label_tag Sample.human_attribute_name :collection_date %>
    <%= date_field :collection_date, '', class: 'form-control', value: Date.today %>
  </div>

  <div class="form-group">
    <%= label_tag Sample.human_attribute_name :bottles_number %>
    <%= text_field_tag :bottles_number, '', class: 'form-control', value: '1' %>
  </div>

  <div class="form-group">
    <%= label_tag Sample.human_attribute_name :storage_location %>
    <%= text_field_tag :storage_location, '', class: 'form-control' %>
  </div>

  <button id="btn_add_sample" class="btn btn-outline-info float-right">
    Adicionar
  </button>

  <%= f.fields_for :samples do |samples_form| %>
    <%= samples_form.text_area :samples, value: '', id: 'samples', class: 'form-control', hidden: true %>
  <% end %>


</div>



<table class="table table-bordered text-center mt-5">
  <thead class="bg-dark text-white">
    <th>
      <h4>
        <%= Sample.human_attribute_name :sample_kind %>
      </h4>
    </th>
    <th>
      <h4>
        <%= Sample.human_attribute_name :collection_date %>
      </h4>
    </th>
    <th>
      <h4>
        <%= Sample.human_attribute_name :bottles_number %>
      </h4>
    </th>
    <th>
      <h4>
        <%= Sample.human_attribute_name :storage_location %>
      </h4>
    </th>
    <th hidden>Index</th>
    <th></th>
  </thead>
  <tbody id='samples_table'>
  </tbody>
</table>

<script>
  $('#samples').val('')
</script>

<script>
  function remove_sample_line(event){
    event.preventDefault()
    let line = event.target.parentNode.parentNode
    let remove_index = parseInt($(line).find('.index').text())
    let samples = $('#samples').val()
    samples = JSON.parse(samples)
    delete samples[remove_index]
    samples = samples.filter(Boolean);
    line.remove()
    $('#samples').val(JSON.stringify(samples))
    document.querySelectorAll('.index').forEach((element, index) => element.textContent = index )
  }
</script>

<script>
  $('#btn_add_sample').click(event => {
    event.preventDefault()
    if ($('#bottles_number').val().length === 0)
      alert('Informe o n√∫mero de frascos.')
    else{
      let sample_kind_id = $('#sample_kind').val()
      let sample_kind_name = $('#sample_kind option:selected').text()
      let collection_date = $('#collection_date_').val()
      let bottles_number = $('#bottles_number').val()
      let storage_location = $('#storage_location').val()
      let sample = {
        sample_kind_id,
        sample_kind_name,
        collection_date,
        bottles_number,
        storage_location
      }
      let samples = $('#samples').val()
      const sample_index = $('.btn-outline-danger').length
      $('#samples_table').append(`
        <tr>
          <td>${sample.sample_kind_name}</td>
          <td>${sample.collection_date}</td>
          <td>${sample.bottles_number}</td>
          <td>${sample.storage_location}</td>
          <td class="index" hidden>${sample_index}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="remove_sample_line(event)">
              Remover
            </button>
          </td>
        </tr>
      `)
      delete sample.sample_kind_name
      if (samples.length === 0){
        $('#samples').val(JSON.stringify([sample]))
      }else{
        let new_value = JSON.parse(samples)
        new_value.push(sample)
        $('#samples').val(JSON.stringify(new_value))
      }
      $('#bottles_number').val('')
      $('#storage_location').val('')
    }
  })
</script>
